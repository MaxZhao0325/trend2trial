name: Release

on:
  workflow_dispatch:
    inputs:
      bump:
        description: "Version bump type"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: pnpm

      - run: pnpm install --frozen-lockfile

      - name: Compute new version
        id: version
        run: |
          CURRENT=$(node -p "require('./packages/cli/package.json').version")
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
          case "${{ inputs.bump }}" in
            major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
            minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
            patch) PATCH=$((PATCH + 1)) ;;
          esac
          NEW="${MAJOR}.${MINOR}.${PATCH}"
          echo "version=$NEW" >> "$GITHUB_OUTPUT"
          echo "Bumping $CURRENT -> $NEW (${{ inputs.bump }})"

      - name: Bump versions in package.json files
        run: |
          VERSION=${{ steps.version.outputs.version }}
          node -e "
            const fs = require('fs');
            for (const p of ['./package.json', './packages/cli/package.json']) {
              const pkg = JSON.parse(fs.readFileSync(p, 'utf8'));
              pkg.version = '${VERSION}';
              fs.writeFileSync(p, JSON.stringify(pkg, null, 2) + '\n');
            }
          "

      - name: Generate changelog
        id: changelog
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            LOG=$(git log "${PREV_TAG}..HEAD" --pretty=format:"- %s (%h)" --no-merges)
          else
            LOG=$(git log --pretty=format:"- %s (%h)" --no-merges -20)
          fi
          {
            echo "changelog<<CHANGELOG_EOF"
            echo "$LOG"
            echo "CHANGELOG_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Commit and tag
        run: |
          VERSION=${{ steps.version.outputs.version }}
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json packages/cli/package.json
          git commit -m "release: v${VERSION}"
          git tag "v${VERSION}"
          git push origin main --follow-tags

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: v${{ steps.version.outputs.version }}
          body: |
            ## Changes

            ${{ steps.changelog.outputs.changelog }}
          generate_release_notes: false
